"use strict";function onSuccess(e,t,n){t.info=setTopResults(e),n.isDataLoaded=!0}function onError(e,t){t.isDataLoaded=!0,t.isError=!0,t.message=e.status+""+e.statusText}function setTopResults(e){for(var t=0;t<e.results.length&&("C"===e.results[t].ACT_RESULT&&6>t);t++)e.results[t].POINTS_RANK=t+1;return e}function handleMaintanance(e){e.go("app.service")}angular.module("app",["ui.router","ngResource","ngMaterial","chart.js"]).config(["$stateProvider","$urlRouterProvider","ChartJsProvider",function(e,t,n){n.setOptions({chartColors:["#00ADF9","#BD4C4C"]}),Chart.defaults.global.elements.point.radius=0,Chart.defaults.global.elements.point.borderWidth=0,Chart.defaults.global.elements.point.hitRadius=3,e.state("app",{url:"/",views:{header:{templateUrl:"views/header.html"},content:{templateUrl:"views/main.html",controller:"HomeController as homeCtrl"},footer:{templateUrl:"views/footer.html"}}}).state("app.runners",{url:"runners",views:{"content@":{templateUrl:"views/runnersTable.html",controller:"RunnersController as runnersCtrl"}}}).state("app.runner",{url:"runners/:id",views:{"content@":{templateUrl:"views/runnerView.html",controller:"RunnerViewController as runnerViewCtrl"}}}).state("app.competitions",{url:"competitions",views:{"content@":{templateUrl:"views/competitionsTable.html",controller:"CompetitionsController as competitionsCtrl"}}}).state("app.competition",{url:"competitions/:id",views:{"content@":{templateUrl:"views/competitionView.html",controller:"CompetitionViewController as competitionViewCtrl"}}}).state("app.about",{url:"about",views:{"content@":{templateUrl:"views/about.html",controller:"AboutController as ctrl"}}}).state("app.adminRunners",{url:"admin/runners",views:{"content@":{templateUrl:"views/adminRunners.html",controller:"AdminRunnersController as AdminRunnersCtrl"}}}).state("app.adminCompetitions",{url:"admin/competitions",views:{"content@":{templateUrl:"views/adminCompetitions.html",controller:"AdminCompetitionsController as AdminCompCtrl"}}}).state("app.service",{url:"ooops",views:{"content@":{templateUrl:"views/service.html"}}}),t.otherwise("/")}]),angular.module("app").controller("HomeController",["$scope","statsService","$state",function(e,t,n){var o=this;o.info=[],e.isDataLoaded=!1,e.isError=!1,e.message="",o.data={},t.getStats().get().$promise.then(function(t){o.data=t.stats,e.isDataLoaded=!0},function(t){434===t.status&&handleMaintanance(n),e.message=t.error,e.isError=!0,e.isDataLoaded=!0})}]).controller("CompetitionsController",["$scope","competitionsService","$state",function(e,t,n){var o=this;o.info=[],e.isDataLoaded=!1,e.isError=!1,e.message="",t.getCompetitions().query(function(t){o.info=t,e.isDataLoaded=!0},function(t){434===t.status&&handleMaintanance(n),e.isDataLoaded=!0,e.isError=!0,e.message=t.status+""+t.statusText})}]).controller("CompetitionViewController",["$scope","$stateParams","competitionsService","$state",function(e,t,n,o){function r(e){if(0===e.length)return null;for(var t=[[]],n=e[0].COMP_GROUP,o=0;o<e.length;o++)e[o].COMP_GROUP===n?t[t.length-1].push(e[o]):(t.push([e[o]]),n=e[o].COMP_GROUP);return t}var i=this;i.info=[],e.isDataLoaded=!1,e.isError=!1,e.message="",n.getCompetition().get({id:parseInt(t.id,10)}).$promise.then(function(t){t.details[0].runners=t.results.length,t.results=r(t.results),i.info=t,e.isDataLoaded=!0},function(t){434===t.status&&handleMaintanance(o),e.isDataLoaded=!0,e.isError=!0,e.message=t.status+""+t.statusText})}]).controller("RunnersController",["$scope","runnerService","$state",function(e,t,n){function o(e,t,n){for(var o=0;o<e.length;o+=1)if(e[o][t]===n)return o;return-1}var r=this;r.info=[],e.isDataLoaded=!1,e.isError=!1,e.message="",r.manFilter="",r.womanFilter="",r.manShift=null,r.womanShift=null,r.manData=[],r.womanData=[],r.search=function(e){if("M"===e.SEX){var t=r.manFilter.toLowerCase();return-1!=e.FULLNAME.toLowerCase().indexOf(t)||-1!=e.TEAM.toLowerCase().indexOf(t)}var t=r.womanFilter.toLowerCase();return-1!=e.FULLNAME.toLowerCase().indexOf(t)||-1!=e.TEAM.toLowerCase().indexOf(t)},r.subjectiveFilter=function(e){return"M"===e.SEX?r.noSubjectiveMan?"Y"!==e.SUBJECTIVE:!0:r.noSubjectiveWoman?"Y"!==e.SUBJECTIVE:!0},t.getRunners().query(function(t){e.isDataLoaded=!0;var n=o(t,"SEX","W");r.manData=t.slice(0,n-1),r.womanData=t.slice(n),r.manShift=-r.manData[0].CUR_RANK,r.womanShift=-r.womanData[0].CUR_RANK,r.info=t},function(t){434===t.status&&handleMaintanance(n),e.isDataLoaded=!0,e.isError=!0,e.message=t.status+""+t.statusText}),r.isSubjective=function(e){return"Y"===e?"subjective-points":""},r.getPopup=function(e){return null===e.PLACE_DIFF?"Новый спортсмен":"Место "+-e.PLACE_DIFF+" \n Очки "+-e.POINTS_DIFF},r.checkPlace=function(e){return e.PLACE_DIFF>0?"glyphicon-circle-arrow-up color-green":e.PLACE_DIFF<0?"glyphicon-circle-arrow-down color-red":null===e.PLACE_DIFF?"glyphicon glyphicon-plus-sign color-blue":"glyphicon-circle-arrow-right color-grey"}}]).controller("RunnerViewController",["$scope","$stateParams","runnerService","$state",function(e,t,n,o){function r(t,n){var o=t.map(function(e){return e.ENTRY_DATE.slice(0,e.ENTRY_DATE.indexOf("T"))}),r=t.map(function(e){return e.POINTS}),i=t.map(function(e){return e.PLACE});e.labels=o,e.series=["очки","место"],e.data=[r,i],e.datasetOverride=[{yAxisID:"y-axis-1"},{yAxisID:"y-axis-2"}],e.options={scales:{yAxes:[{id:"y-axis-1",type:"linear",display:!0,position:"left"},{id:"y-axis-2",type:"linear",display:!0,position:"right",ticks:{min:1}}]}}}var i=this;i.info=[],e.isDataLoaded=!1,e.isError=!1,e.message="",n.getRunner().get({id:parseInt(t.id,10)}).$promise.then(function(t){r(t.stats,t.details[0].FULLNAME),onSuccess(t,i,e)},function(t){434===t.status&&handleMaintanance(o),onError(t,e)})}]).controller("AboutController",["aboutService","$scope","$state",function(e,t,n){var o=this;o.groups="(Загрузка..)",t.isDataLoaded=!1,t.showInfo=!1,t.toggleInfo=function(){t.showInfo=!t.showInfo},e.getGoupsData().query(function(e){o.groups=e.map(function(e){return e.name}).join(", "),o.points=e,t.isDataLoaded=!0},function(e){434===e.status&&handleMaintanance(n),t.isDataLoaded=!0,t.isError=!0,t.message=e.status+""+e.statusText})}]).controller("LoginController",["$mdDialog","$mdMedia","$mdToast","$state",function(e,t,n,o){var r=!1;this.showPrompt=function(t){e.show({clickOutsideToClose:!0,controller:"LoginDialogController as ctrl",templateUrl:"views/templates/loginPopup.html",parent:angular.element(document.body),targetEvent:t,fullscreen:r}).then(function(e){o.go(e.adminPanel)},function(){console.log("cancel")})}}]).controller("AdminCompetitionsController",["$scope","adminCompetitionsService","$state",function(e,t,n){function o(e){return e.map(function(e){return e.IS_ALLOWED_UPDATED=e.IS_ALLOWED,e})}var r=this;r.info=[],e.message="",e.newCompetition="",e.addCompetition=function(){return e.message="Adding...",e.newCompetition?(t.addLink().update({data:e.newCompetition},function(t){t.error||r.info.push(o([t.data])),e.message=t.error||"Competition added"}),void(e.newCompetition="")):void(e.message="Empty link!")},e.recalculate=function(){e.message="Recalculation...",t.recalculateCompetitions().update({data:r.info},function(t){t.error||(r.info=o(JSON.parse(t.data))),e.message=t.error||"Competitions updated"}),e.newCompetition=""},e.dropData=function(){e.message="Drop and Update...",t.dropData().update({},function(t){t.error||(r.info=o(JSON.parse(t.data))),e.message=t.error||"Competitions updated"}),e.newCompetition=""},e.updateCompetition=function(){e.message="Updating...",t.updateCompetition().update({data:{id:r.selectedCompetition.ID,title:r.selectedCompetition.NAME}},function(t){e.message=t.data||"Data updated"})},r.info=[],t.getCompetitions().query(function(e){r.info=o(e)},function(t){401===t.status?n.go("app"):e.message=t.status+""+t.statusText})}]).controller("AdminRunnersController",["$scope","adminRunnersService","$state",function(e,t,n){var o=this;e.info=[],o.selectedRunner={},e.show=!1,e.selectedRunners=[],e.mergedRunners=[],e.isMerge=!1,e.message="";var r=[];e.filterInfo=function(t){return 0===r.length?t:e.info.filter(function(e){return-1===r.indexOf(e.ID)})},e.$watch("selectedRunners",function(){e.isMerge=e.selectedRunners.length>2}),e.merge=function(){e.mergedRunners.push({main:o.selectedRunner,duplicates:e.selectedRunners}),o.selectedRunner={},e.show=!1;for(var t=0;t<e.selectedRunners.length;t++)e.selectedRunners[t].isSelected=!1,r.push(e.selectedRunners[t].ID);e.selectedRunners=[]},e.cancel=function(){r=[],e.mergedRunners=[],e.selectedRunners=[],o.selectedRunner={},e.show=!1;for(var t=0;t<e.selectedRunners.length;t++)e.selectedRunners[t].isSelected=!1},e.updateMergedData=function(){e.message="Merging...",t.mergeDuplicates().update(e.mergedRunners,function(t){t.error||(e.info=JSON.parse(t.data)),e.message=t.error||"Runners updated",r=[]})},e.update=function(){e.message="Updating...",t.updateRunner().update({data:o.selectedRunner},function(t){e.message=t.error||"Runner updated"}),o.selectedRunner={},e.show=!1;for(var n=0;n<e.selectedRunners.length;n++)e.selectedRunners[n].isSelected=!1},this.selected=function(t){t.isSelected||t!==o.selectedRunner||(e.show=!1,o.selectedRunner={})},this.selectedPrimary=function(t){e.show=!0},t.getRunners().query(function(t){console.log(t),e.info=t},function(e){401===e.status&&n.go("app")})}]).controller("LoginDialogController",["$mdDialog","loginService","$state",function(e,t,n){var o=this;o.password="",o.username="admin01",o.close=function(){o.wrongPass=!1,e.cancel()},o.login=function(){o.wrongPass=!1,o.loading=!0,t.adminLogin().check({user:o.username,password:o.password},function(t){return o.loading=!1,t.error?void(o.wrongPass=!0):void e.hide(t)},function(e){o.loading=!1,o.service=!0})}}]),angular.module("app").service("competitionsService",["$resource",function(e){this.getCompetitions=function(){return e("/competitions")},this.getCompetition=function(){return e("/competitions/:id")}}]).service("runnerService",["$resource",function(e){this.getRunners=function(){return e("/runners")},this.getRunner=function(){return e("/runners/:id")}}]).service("statsService",["$resource",function(e){this.getStats=function(){return e("/stats")}}]).service("adminCompetitionsService",["$resource",function(e){this.getCompetitions=function(){return e("admin/competitions")},this.addLink=function(){return e("admin/competitions/addCompetition",null,{update:{method:"PUT"},query:{method:"GET",isArray:!0}})},this.recalculateCompetitions=function(){return e("admin/competitions/recalculate",null,{update:{method:"PUT"},query:{method:"GET",isArray:!0}})},this.dropData=function(){return e("admin/competitions/drop",null,{update:{method:"PUT"},query:{method:"GET",isArray:!0}})},this.updateCompetition=function(){return e("admin/competitions/updateCompetitionDetails",null,{update:{method:"PUT"},query:{method:"GET",isArray:!1}})}}]).service("adminRunnersService",["$resource",function(e){this.getRunners=function(){return e("admin/runners")},this.mergeDuplicates=function(){return e("admin/runners/merge",null,{update:{method:"PUT"},query:{method:"GET",isArray:!1}})},this.updateRunner=function(){return e("admin/runners/update",null,{update:{method:"PUT"},query:{method:"GET",isArray:!1}})}}]).service("loginService",["$resource",function(e){this.adminLogin=function(){return e("/adminLogin",null,{check:{method:"PUT"}})}}]).service("aboutService",["$resource",function(e){this.getGoupsData=function(){return e("/about")}}]),angular.module("app").directive("loaderTemplate",function(){return{restrict:"E",templateUrl:"views/templates/loader.html"}}).component("loginComponent",{templateUrl:"views/templates/login.html",controller:"LoginController"});